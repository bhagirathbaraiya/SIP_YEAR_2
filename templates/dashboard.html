{% extends "base.html" %}

{% block title %}Bot Dashboard - Telegram Bot Analytics{% endblock %}

{% block content %}
<div class="space-y-6 max-w-full overflow-x-hidden">
    <!-- Header -->
    <div class="flex items-center gap-3">
        <i class="ri-dashboard-line text-2xl text-blue-600"></i>
        <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-200">Bot Dashboard</h2>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="p-4 rounded-lg bg-blue-100/50 dark:bg-blue-900/20">
            <h3 class="font-medium text-blue-800 dark:text-blue-200">Total Images</h3>
            <p class="text-2xl font-bold text-blue-600" id="totalImages">0</p>
        </div>
        <div class="p-4 rounded-lg bg-green-100/50 dark:bg-green-900/20">
            <h3 class="font-medium text-green-800 dark:text-green-200">Total Users</h3>
            <p class="text-2xl font-bold text-green-600" id="totalUsers">0</p>
        </div>
        <div class="p-4 rounded-lg bg-yellow-100/50 dark:bg-yellow-900/20">
            <h3 class="font-medium text-yellow-800 dark:text-yellow-200">Total Messages</h3>
            <p class="text-2xl font-bold text-yellow-600" id="totalMessages">0</p>
        </div>
        <div class="p-4 rounded-lg bg-purple-100/50 dark:bg-purple-900/20">
            <h3 class="font-medium text-purple-800 dark:text-purple-200">Total Downloads</h3>
            <p class="text-2xl font-bold text-purple-600" id="totalDownloads">0</p>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Message Types Distribution -->
        <div class="p-4 sm:p-6 rounded-lg bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm w-full">
            <h3 class="mb-4 font-medium text-slate-800 dark:text-slate-200">Message Types Distribution</h3>
            <div class="h-[250px] sm:h-[300px] w-full">
                <canvas id="messageTypesChart"></canvas>
            </div>
        </div>

        <!-- Message Success Rate -->
        <div class="p-4 sm:p-6 rounded-lg bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm w-full">
            <h3 class="mb-4 font-medium text-slate-800 dark:text-slate-200">Message Success Rate</h3>
            <div class="h-[250px] sm:h-[300px] w-full">
                <canvas id="messageSuccessChart"></canvas>
            </div>
        </div>

        <!-- User Status Distribution -->
        <div class="p-4 sm:p-6 rounded-lg bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm w-full">
            <h3 class="mb-4 font-medium text-slate-800 dark:text-slate-200">User Status Distribution</h3>
            <div class="h-[250px] sm:h-[300px] w-full">
                <canvas id="userStatusChart"></canvas>
            </div>
        </div>

        <!-- Image Status Distribution -->
        <div class="p-4 sm:p-6 rounded-lg bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm w-full">
            <h3 class="mb-4 font-medium text-slate-800 dark:text-slate-200">Image Status Distribution</h3>
            <div class="h-[250px] sm:h-[300px] w-full">
                <canvas id="imageStatusChart"></canvas>
            </div>
        </div>

        <!-- Hourly Activity -->
        <div class="p-4 sm:p-6 rounded-lg bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm w-full">
            <h3 class="mb-4 font-medium text-slate-800 dark:text-slate-200">Hourly Activity</h3>
            <div class="h-[250px] sm:h-[300px] w-full">
                <canvas id="hourlyActivityChart"></canvas>
            </div>
        </div>

        <!-- User Activity Over Time -->
        <div class="p-4 sm:p-6 rounded-lg bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm w-full">
            <h3 class="mb-4 font-medium text-slate-800 dark:text-slate-200">User Activity Over Time</h3>
            <div class="h-[250px] sm:h-[300px] w-full">
                <canvas id="userActivityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity & System Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
        <!-- Recent Activity -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="p-3 sm:p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Recent Activity</h3>
            </div>
            <div class="p-3 sm:p-4">
                <div class="space-y-3 sm:space-y-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="p-2 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-md">
                                <i class="ri-user-add-line text-lg sm:text-xl text-white"></i>
                            </div>
                        </div>
                        <div class="ml-3 min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">New user registered</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 truncate">John Doe joined the platform</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">2 minutes ago</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md">
                                <i class="ri-message-2-line text-lg sm:text-xl text-white"></i>
                            </div>
                        </div>
                        <div class="ml-3 min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">New message in Broadcast Channel</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 truncate">Admin posted an announcement</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">5 minutes ago</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="p-2 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-md">
                                <i class="ri-group-line text-lg sm:text-xl text-white"></i>
                            </div>
                        </div>
                        <div class="ml-3 min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">New group created</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 truncate">Community Chat group was created</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">10 minutes ago</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="p-3 sm:p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">System Status</h3>
            </div>
            <div class="p-3 sm:p-4">
                <div class="space-y-3 sm:space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                            <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md flex-shrink-0">
                                <i class="ri-server-line text-lg sm:text-xl text-white"></i>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-100 truncate">Server Status</span>
                        </div>
                        <span class="px-2 sm:px-3 py-1 text-xs font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 flex-shrink-0">Operational</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                            <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md flex-shrink-0">
                                <i class="ri-database-2-line text-lg sm:text-xl text-white"></i>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-100 truncate">Database Status</span>
                        </div>
                        <span class="px-2 sm:px-3 py-1 text-xs font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 flex-shrink-0">Operational</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                            <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md flex-shrink-0">
                                <i class="ri-cloud-line text-lg sm:text-xl text-white"></i>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-100 truncate">API Status</span>
                        </div>
                        <span class="px-2 sm:px-3 py-1 text-xs font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 flex-shrink-0">Operational</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                            <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md flex-shrink-0">
                                <i class="ri-shield-check-line text-lg sm:text-xl text-white"></i>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-100 truncate">Security Status</span>
                        </div>
                        <span class="px-2 sm:px-3 py-1 text-xs font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 flex-shrink-0">Protected</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Fetch data from API
    let botData = null;

    async function fetchBotData() {
        try {
            const response = await fetch('/api/bot-data');
            botData = await response.json();
            return botData;
        } catch (error) {
            console.error('Error fetching bot data:', error);
            return null;
        }
    }

    // Chart colors
    const COLORS = ['#2563eb', '#16a34a', '#eab308', '#db2777'];
    const STATUS_COLORS = {
        allowed: '#16a34a',
        blocked: '#dc2626',
        pending: '#eab308'
    };

    // Initialize dashboard
    async function initializeDashboard() {
        const fetchedData = await fetchBotData();
        if (!fetchedData) return;
        
        const data = fetchedData.MU_BOT;
        
        // Calculate stats
        const totalStudentImages = Object.keys(data.IMAGES.student).length;
        const totalFacultyImages = Object.keys(data.IMAGES.faculty).length;
        const totalImages = totalStudentImages + totalFacultyImages;
        const totalUsers = Object.keys(data.USERS).length;
        const totalMessages = Object.keys(data.MESSAGES).length;
        
        // Calculate downloads
        const studentDownloads = Object.values(data.IMAGES.student).reduce((acc, img) => acc + img.download_counter, 0);
        const facultyDownloads = Object.values(data.IMAGES.faculty).reduce((acc, img) => acc + img.download_counter, 0);
        const totalDownloads = studentDownloads + facultyDownloads;
        
        // Update stats
        document.getElementById('totalImages').textContent = totalImages;
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('totalMessages').textContent = totalMessages;
        document.getElementById('totalDownloads').textContent = totalDownloads;
        
        // Create charts
        createMessageTypesChart(data.MESSAGES);
        createMessageSuccessChart(data.MESSAGES);
        createUserStatusChart(data.USERS);
        createImageStatusChart(data.IMAGES);
        createHourlyActivityChart(data.MESSAGES);
        createUserActivityChart(data.MESSAGES);
    }

    // Message Types Chart
    function createMessageTypesChart(messages) {
        const messageTypes = Object.values(messages).reduce((acc, msg) => {
            acc[msg.message_type] = (acc[msg.message_type] || 0) + 1;
            return acc;
        }, {});
        
        const ctx = document.getElementById('messageTypesChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(messageTypes),
                datasets: [{
                    data: Object.values(messageTypes),
                    backgroundColor: COLORS
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Message Success Chart
    function createMessageSuccessChart(messages) {
        const messageStatus = Object.values(messages).reduce((acc, msg) => {
            acc[msg.message_status] = (acc[msg.message_status] || 0) + 1;
            return acc;
        }, {});
        
        const ctx = document.getElementById('messageSuccessChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(messageStatus),
                datasets: [{
                    data: Object.values(messageStatus),
                    backgroundColor: Object.keys(messageStatus).map(status => 
                        status === 'success' ? '#16a34a' : '#dc2626'
                    )
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // User Status Chart
    function createUserStatusChart(users) {
        const userStatus = Object.values(users).reduce((acc, user) => {
            acc[user.data.status] = (acc[user.data.status] || 0) + 1;
            return acc;
        }, {});
        
        const ctx = document.getElementById('userStatusChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(userStatus),
                datasets: [{
                    data: Object.values(userStatus),
                    backgroundColor: Object.keys(userStatus).map(status => STATUS_COLORS[status] || '#2563eb')
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Image Status Chart
    function createImageStatusChart(images) {
        const imageStatus = {};
        
        // Process student images
        Object.values(images.student).forEach(image => {
            imageStatus[image.status] = (imageStatus[image.status] || 0) + 1;
        });
        
        // Process faculty images
        Object.values(images.faculty).forEach(image => {
            imageStatus[image.status] = (imageStatus[image.status] || 0) + 1;
        });
        
        const ctx = document.getElementById('imageStatusChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(imageStatus),
                datasets: [{
                    data: Object.values(imageStatus),
                    backgroundColor: Object.keys(imageStatus).map(status => STATUS_COLORS[status] || '#2563eb')
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Hourly Activity Chart
    function createHourlyActivityChart(messages) {
        const hourlyActivity = Object.values(messages).reduce((acc, msg) => {
            const hour = new Date(msg.time_stamp).getHours();
            const hourKey = `${hour}:00`;
            acc[hourKey] = (acc[hourKey] || 0) + 1;
            return acc;
        }, {});
        
        const sortedHours = Object.keys(hourlyActivity).sort();
        
        const ctx = document.getElementById('hourlyActivityChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedHours,
                datasets: [{
                    label: 'Messages',
                    data: sortedHours.map(hour => hourlyActivity[hour]),
                    backgroundColor: '#2563eb'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // User Activity Over Time Chart
    function createUserActivityChart(messages) {
        const dailyActivity = Object.values(messages).reduce((acc, msg) => {
            const date = msg.time_stamp.split('T')[0];
            acc[date] = (acc[date] || 0) + 1;
            return acc;
        }, {});
        
        const sortedDates = Object.keys(dailyActivity).sort();
        
        const ctx = document.getElementById('userActivityChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'Messages',
                    data: sortedDates.map(date => dailyActivity[date]),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeDashboard);
</script>
{% endblock %}