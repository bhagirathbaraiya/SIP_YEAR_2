{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Customers</h1>
        <div class="flex items-center gap-2">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search customers..." 
                    class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                <i class="ri-search-line absolute left-3 top-2.5 text-gray-400"></i>
            </div>
            <select id="sortSelect" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                <option value="unread">Unread First</option>
                <option value="recent">Most Recent</option>
                <option value="name">Name</option>
            </select>
            <button class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                <i class="ri-user-add-line mr-2"></i>
                Add Customer
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden">
        <div class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden">
        <div class="text-center py-12">
            <div class="mx-auto h-12 w-12 text-gray-400">
                <i class="ri-user-search-line text-4xl"></i>
            </div>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No customers found</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Try adjusting your search or filters.</p>
        </div>
    </div>

    <!-- Customers Grid -->
    <div id="customersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Customer cards will be dynamically populated -->
    </div>
</div>

<!-- Chat Modal -->
<div id="chatModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50">
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                <!-- Chat Header -->
                <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="flex items-center gap-3">
                        <div>
                            <h3 id="chatUserName" class="text-lg font-semibold text-gray-900 dark:text-white">John Doe</h3>
                            <p id="chatUserStatus" class="text-sm text-gray-500 dark:text-gray-400">Online</p>
                        </div>
                    </div>
                    <button onclick="closeChat()" class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="mt-4 space-y-4 max-h-96 overflow-y-auto">
                    <!-- Messages will be dynamically added here -->
                </div>

                <!-- Chat Input -->
                <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <form id="chatForm" class="flex gap-2" onsubmit="sendMessage(event)">
                        <input type="text" id="messageInput" placeholder="Type a message..."
                            class="flex-1 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                        <button type="submit" class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                            <i class="ri-send-plane-line"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div id="addCustomerModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50">
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add New Customer</h3>
                    <button onclick="closeAddCustomerModal()" class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <div class="mt-4">
                    <form id="addCustomerForm" onsubmit="handleAddCustomer(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="telegramId" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Telegram ID</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="telegramId" name="telegramId" required
                                        class="flex-1 rounded-l-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"
                                        placeholder="Enter Telegram ID">
                                    <button type="button" onclick="fetchTelegramUser()"
                                        class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-r-lg hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <i class="ri-search-line mr-2"></i>
                                        Check
                                    </button>
                                </div>
                            </div>

                            <!-- User Preview (shown after checking Telegram ID) -->
                            <div id="userPreview" class="hidden">
                                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                    <div class="flex items-center space-x-4">
                                        <img id="previewProfilePic" src="" alt="Profile" class="w-16 h-16 rounded-full">
                                        <div>
                                            <h4 id="previewName" class="text-lg font-semibold text-gray-900 dark:text-white"></h4>
                                            <p id="previewUsername" class="text-sm text-gray-500 dark:text-gray-400"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeAddCustomerModal()"
                                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    Cancel
                                </button>
                                <button type="submit" id="addCustomerButton" disabled
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Add Customer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Enhanced customer data structure
    const customerData = {
        'john_doe': {
            name: 'John Doe',
            username: '@john_doe',
            status: 'Online',
            lastActive: new Date(Date.now() - 5 * 60 * 1000), // 5 minutes ago
            unreadCount: 2,
            profilePic: 'https://ui-avatars.com/api/?name=John+Doe&background=random',
            messages: [
                { sender: 'user', text: 'Hello! How can I help you today?', time: '10:00 AM', read: true },
                { sender: 'them', text: 'Hi! I have a question about the bot.', time: '10:01 AM', read: false },
                { sender: 'them', text: 'Can you help me with that?', time: '10:02 AM', read: false }
            ]
        },
        'jane_smith': {
            name: 'Jane Smith',
            username: '@jane_smith',
            status: 'Offline',
            lastActive: new Date(Date.now() - 60 * 60 * 1000), // 1 hour ago
            unreadCount: 0,
            messages: [
                { sender: 'user', text: 'Hello Jane!', time: '9:30 AM', read: true },
                { sender: 'them', text: 'Hi there!', time: '9:31 AM', read: true }
            ]
        },
        'mike_johnson': {
            name: 'Mike Johnson',
            username: '@mike_johnson',
            status: 'Online',
            lastActive: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            unreadCount: 1,
            messages: [
                { sender: 'them', text: 'Hey, I need some assistance.', time: '11:00 AM', read: false },
                { sender: 'user', text: 'Of course! How can I help?', time: '11:01 AM', read: true }
            ]
        },
        'sarah_wilson': {
            name: 'Sarah Wilson',
            username: '@sarah_wilson',
            status: 'Offline',
            lastActive: new Date(Date.now() - 30 * 60 * 1000), // 30 minutes ago
            unreadCount: 0,
            messages: [
                { sender: 'user', text: 'Hello Sarah!', time: '2:00 PM', read: true },
                { sender: 'them', text: 'Hi! Thanks for reaching out.', time: '2:01 PM', read: true }
            ]
        }
    };

    // Generate 50 users with dummy data
    const firstNames = ['John', 'Jane', 'Mike', 'Sarah', 'David', 'Emma', 'James', 'Lisa', 'Robert', 'Anna', 'William', 'Maria', 'Michael', 'Sophia', 'Daniel', 'Olivia', 'Matthew', 'Isabella', 'Christopher', 'Ava', 'Andrew', 'Mia', 'Joseph', 'Charlotte', 'Thomas', 'Amelia', 'Charles', 'Harper', 'Edward', 'Evelyn', 'Henry', 'Abigail', 'Samuel', 'Emily', 'Benjamin', 'Elizabeth', 'Alexander', 'Sofia', 'Nathan', 'Avery', 'Ryan', 'Ella', 'Tyler', 'Scarlett', 'Nicholas', 'Grace', 'Anthony', 'Chloe', 'Jonathan', 'Victoria'];
    const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson', 'Walker', 'Young', 'Allen', 'King', 'Wright', 'Scott', 'Torres', 'Nguyen', 'Hill', 'Flores', 'Green', 'Adams', 'Nelson', 'Baker', 'Hall', 'Rivera', 'Campbell', 'Mitchell', 'Carter', 'Roberts'];

    // Generate random messages
    const messageTemplates = [
        "Hello! How can I help you today?",
        "I have a question about your services.",
        "Can you provide more information?",
        "Thanks for your assistance!",
        "I'm interested in learning more.",
        "What are your business hours?",
        "Do you offer any discounts?",
        "I need help with my account.",
        "Can you explain the pricing?",
        "I'd like to schedule a meeting."
    ];

    // Generate 50 users
    for (let i = 0; i < 50; i++) {
        const firstName = firstNames[i];
        const lastName = lastNames[i];
        const username = `@${firstName.toLowerCase()}_${lastName.toLowerCase()}`;
        const status = Math.random() > 0.5 ? 'Online' : 'Offline';
        const lastActive = new Date(Date.now() - Math.floor(Math.random() * 24 * 60 * 60 * 1000));
        const unreadCount = Math.floor(Math.random() * 5);
        const profilePic = `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=random`;

        // Generate random messages
        const messages = [];
        const numMessages = Math.floor(Math.random() * 5) + 2;
        for (let j = 0; j < numMessages; j++) {
            const isUser = j % 2 === 0;
            const messageText = messageTemplates[Math.floor(Math.random() * messageTemplates.length)];
            const time = new Date(Date.now() - Math.floor(Math.random() * 24 * 60 * 60 * 1000)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messages.push({
                sender: isUser ? 'user' : 'them',
                text: messageText,
                time: time,
                read: Math.random() > 0.3
            });
        }

        customerData[username.substring(1)] = {
            name: `${firstName} ${lastName}`,
            username: username,
            status: status,
            lastActive: lastActive,
            unreadCount: unreadCount,
            profilePic: profilePic,
            messages: messages
        };
    }

    let currentChat = null;
    let searchTimeout = null;

    // Initialize the page
    function initializePage() {
        renderCustomerCards();
        setupEventListeners();
        startStatusUpdates();
    }

    // Render customer cards
    function renderCustomerCards(customers = Object.values(customerData)) {
        const customersGrid = document.getElementById('customersGrid');
        customersGrid.innerHTML = '';

        if (customers.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('customersGrid').classList.add('hidden');
            return;
        }

        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('customersGrid').classList.remove('hidden');

        // Sort customers based on selected option
        const sortSelect = document.getElementById('sortSelect');
        const sortOption = sortSelect.value;
        
        customers.sort((a, b) => {
            switch (sortOption) {
                case 'unread':
                    return b.unreadCount - a.unreadCount;
                case 'recent':
                    return b.lastActive - a.lastActive;
                case 'name':
                    return a.name.localeCompare(b.name);
                default:
                    return 0;
            }
        });

        customers.forEach(customer => {
            const card = createCustomerCard(customer);
            customersGrid.appendChild(card);
        });
    }

    // Create customer card element
    function createCustomerCard(customer) {
        const div = document.createElement('div');
        div.className = 'bg-white dark:bg-gray-800 rounded-xl shadow hover:shadow-lg transition-shadow cursor-pointer transform hover:-translate-y-1 transition-transform';
        div.onclick = () => openChat(customer.username.substring(1));

        const lastActive = getTimeAgo(customer.lastActive);
        const statusClass = customer.status === 'Online' 
            ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
            : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';

        div.innerHTML = `
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="${customer.profilePic}" alt="${customer.name}" class="w-12 h-12 rounded-full">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${customer.name}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${customer.username}</p>
                        </div>
                    </div>
                    ${customer.unreadCount > 0 ? `
                        <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-indigo-600 text-white text-xs font-medium">
                            ${customer.unreadCount}
                        </span>
                    ` : ''}
                </div>
                <div class="mt-4 flex items-center justify-between text-sm">
                    <span class="text-gray-500 dark:text-gray-400">Last active: ${lastActive}</span>
                    <span class="px-2 py-1 ${statusClass} rounded-full text-xs">${customer.status}</span>
                </div>
            </div>
        `;

        return div;
    }

    // Setup event listeners
    function setupEventListeners() {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', handleSearch);

        const sortSelect = document.getElementById('sortSelect');
        sortSelect.addEventListener('change', () => renderCustomerCards());
    }

    // Handle search input
    function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase();
        
        // Only show loading state if there are no customers currently visible
        const customersGrid = document.getElementById('customersGrid');
        const hasVisibleCustomers = customersGrid.children.length > 0;
        
        if (!hasVisibleCustomers) {
            document.getElementById('loadingState').classList.remove('hidden');
            customersGrid.classList.add('hidden');
        }

        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        // Add debounce to search
        searchTimeout = setTimeout(() => {
            const filteredCustomers = Object.values(customerData).filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.username.toLowerCase().includes(searchTerm)
            );

            renderCustomerCards(filteredCustomers);
            document.getElementById('loadingState').classList.add('hidden');
        }, 300);
    }

    // Get time ago string
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + 'y ago';
        
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + 'mo ago';
        
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + 'd ago';
        
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + 'h ago';
        
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + 'm ago';
        
        return Math.floor(seconds) + 's ago';
    }

    // Start periodic status updates
    function startStatusUpdates() {
        setInterval(() => {
            renderCustomerCards();
        }, 30000); // Update every 30 seconds
    }

    function openChat(customerId) {
        currentChat = customerId;
        const customer = customerData[customerId];
        
        // Mark all messages as read
        customer.messages.forEach(message => message.read = true);
        customer.unreadCount = 0;
        
        // Update chat header
        const chatHeader = document.querySelector('#chatModal .flex.items-center.gap-3');
        chatHeader.innerHTML = `
            <img src="${customer.profilePic}" alt="${customer.name}" class="w-12 h-12 rounded-full">
            <div>
                <h3 id="chatUserName" class="text-lg font-semibold text-gray-900 dark:text-white">${customer.name}</h3>
                <p id="chatUserStatus" class="text-sm text-gray-500 dark:text-gray-400">${customer.status}</p>
            </div>
        `;

        // Load messages
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';
        customer.messages.forEach(message => {
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
        });

        // Show modal
        document.getElementById('chatModal').classList.remove('hidden');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Update the customer card to reflect read status
        renderCustomerCards();
    }

    function closeChat() {
        document.getElementById('chatModal').classList.add('hidden');
        currentChat = null;
    }

    function createMessageElement(message) {
        const div = document.createElement('div');
        div.className = `flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`;
        
        div.innerHTML = `
            <div class="max-w-[70%] ${message.sender === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white'} rounded-lg px-4 py-2">
                <p class="text-sm">${message.text}</p>
                <p class="text-xs ${message.sender === 'user' ? 'text-indigo-200' : 'text-gray-500 dark:text-gray-400'} mt-1">${message.time}</p>
            </div>
        `;
        
        return div;
    }

    function sendMessage(event) {
        event.preventDefault();
        if (!currentChat) return;

        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        // Add message to chat data
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        customerData[currentChat].messages.push({
            sender: 'user',
            text: message,
            time: time,
            read: true
        });

        // Add message to UI
        const messagesContainer = document.getElementById('chatMessages');
        const messageElement = createMessageElement({
            sender: 'user',
            text: message,
            time: time,
            read: true
        });
        messagesContainer.appendChild(messageElement);

        // Clear input and scroll to bottom
        input.value = '';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Simulate reply after 1 second
        setTimeout(() => {
            const reply = {
                sender: 'them',
                text: 'Thanks for your message! This is an automated reply.',
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                read: false
            };
            customerData[currentChat].messages.push(reply);
            customerData[currentChat].unreadCount++;
            const replyElement = createMessageElement(reply);
            messagesContainer.appendChild(replyElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update the customer card to show new unread message
            renderCustomerCards();
        }, 1000);
    }

    // Close chat when clicking outside
    document.getElementById('chatModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeChat();
        }
    });

    // Add Customer Modal Functions
    function openAddCustomerModal() {
        document.getElementById('addCustomerModal').classList.remove('hidden');
        document.getElementById('userPreview').classList.add('hidden');
        document.getElementById('addCustomerButton').disabled = true;
        document.getElementById('addCustomerForm').reset();
    }

    function closeAddCustomerModal() {
        document.getElementById('addCustomerModal').classList.add('hidden');
    }

    async function fetchTelegramUser() {
        const telegramId = document.getElementById('telegramId').value.trim();
        if (!telegramId) {
            alert('Please enter a Telegram ID');
            return;
        }

        // Show loading state
        const checkButton = document.querySelector('button[onclick="fetchTelegramUser()"]');
        const originalButtonText = checkButton.innerHTML;
        checkButton.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Checking...';
        checkButton.disabled = true;

        try {
            // Simulate API call to Telegram
            // In a real application, you would make an actual API call to Telegram's API
            await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate network delay

            // Simulate successful response
            const mockUserData = {
                id: telegramId,
                first_name: 'John',
                last_name: 'Doe',
                username: 'johndoe',
                photo_url: `https://ui-avatars.com/api/?name=John+Doe&background=random`
            };

            // Update preview
            document.getElementById('previewProfilePic').src = mockUserData.photo_url;
            document.getElementById('previewName').textContent = `${mockUserData.first_name} ${mockUserData.last_name}`;
            document.getElementById('previewUsername').textContent = `@${mockUserData.username}`;
            document.getElementById('userPreview').classList.remove('hidden');
            document.getElementById('addCustomerButton').disabled = false;

        } catch (error) {
            alert('Failed to fetch Telegram user. Please check the ID and try again.');
        } finally {
            // Reset button state
            checkButton.innerHTML = originalButtonText;
            checkButton.disabled = false;
        }
    }

    function handleAddCustomer(event) {
        event.preventDefault();
        const telegramId = document.getElementById('telegramId').value.trim();
        
        // In a real application, you would make an API call to your backend to add the customer
        // For now, we'll just add it to our local customerData object
        const newCustomer = {
            name: document.getElementById('previewName').textContent,
            username: document.getElementById('previewUsername').textContent,
            status: 'Offline',
            lastActive: new Date(),
            unreadCount: 0,
            profilePic: document.getElementById('previewProfilePic').src,
            messages: []
        };

        const username = newCustomer.username.substring(1);
        customerData[username] = newCustomer;

        // Update the UI
        renderCustomerCards();
        closeAddCustomerModal();

        // Show success message
        alert('Customer added successfully!');
    }

    // Update the Add Customer button click handler
    document.querySelector('button:has(i.ri-user-add-line)').onclick = openAddCustomerModal;

    // Initialize the page when loaded
    document.addEventListener('DOMContentLoaded', initializePage);
</script>
{% endblock %} 