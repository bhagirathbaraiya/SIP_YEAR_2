{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Groups</h1>
        <button onclick="openAddGroupModal()" class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
            <i class="ri-add-line mr-2"></i>
            Add New Group
        </button>
    </div>

    <!-- Groups Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Group Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Members</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Created Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for group in groups %}
                    <tr onclick="openGroupChat('{{ group.group_name }}')" class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                                    <i class="ri-group-line text-xl text-indigo-600 dark:text-indigo-400"></i>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ group.group_name }}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">@{{ group.group_name.lower().replace(' ', '_') }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">{{ group.member_count }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">{{ group.created_at.strftime('%Y-%m-%d') }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Active</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="event.stopPropagation(); openManageMembers('{{ group.group_name }}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-3">
                                <i class="ri-user-add-line"></i>
                            </button>
                            <button onclick="event.stopPropagation(); editGroup('{{ group.id }}')" class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 mr-3">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteGroup('{{ group.id }}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Group Modal -->
<div id="addGroupModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50">
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                <div class="absolute right-0 top-0 pr-4 pt-4">
                    <button onclick="closeAddGroupModal()" class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-white">Add New Group</h3>
                        <div class="mt-4">
                            <form id="addGroupForm" class="space-y-4">
                                <div>
                                    <label for="groupName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Group Name</label>
                                    <input type="text" id="groupName" name="groupName" required
                                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                </div>
                                <div>
                                    <label for="groupType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Group Type</label>
                                    <select id="groupType" name="groupType" required
                                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                        <option value="broadcast">Broadcast Group</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="groupLink" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Group Link</label>
                                    <input type="url" id="groupLink" name="groupLink" required
                                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                </div>
                                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                    <button type="submit"
                                        class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:ml-3 sm:w-auto">
                                        Create Group
                                    </button>
                                    <button type="button" onclick="closeAddGroupModal()"
                                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-white shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Group Chat Modal -->
<div id="groupChatModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50">
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 w-full max-w-4xl h-[90vh] flex flex-col">
                <!-- Chat Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
                    <div class="flex items-center gap-3">
                        <div id="groupChatAvatar" class="h-12 w-12 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                            <i class="ri-group-line text-2xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 id="groupChatName" class="text-lg font-semibold text-gray-900 dark:text-white">Group Name</h3>
                            <p id="groupChatInfo" class="text-sm text-gray-500 dark:text-gray-400">1500 members</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="ri-search-line text-xl"></i>
                        </button>
                        <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="ri-more-2-fill text-xl"></i>
                        </button>
                        <button onclick="closeGroupChat()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="groupChatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100 dark:bg-gray-900" style="max-height: calc(90vh - 180px);">
                    <!-- Messages will be dynamically added here -->
                </div>

                <!-- Chat Input -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                    <form id="groupChatForm" class="flex items-center gap-2" onsubmit="sendGroupMessage(event)">
                        <button type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="ri-emotion-line text-xl"></i>
                        </button>
                        <button type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="ri-attachment-2 text-xl"></i>
                        </button>
                        <input type="text" id="groupMessageInput" placeholder="Type a message..."
                            class="flex-1 rounded-full border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white px-4 py-2">
                        <button type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="ri-mic-line text-xl"></i>
                        </button>
                        <button type="submit" class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white transition-colors">
                            <i class="ri-send-plane-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Members Modal -->
<div id="manageMembersModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50">
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                            <i class="ri-group-line text-xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 id="manageMembersTitle" class="text-lg font-semibold text-gray-900 dark:text-white">Manage Members</h3>
                            <p id="manageMembersSubtitle" class="text-sm text-gray-500 dark:text-gray-400">Add or remove members</p>
                        </div>
                    </div>
                    <button onclick="closeManageMembers()" class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <!-- Search and Add User -->
                <div class="mt-4">
                    <div class="flex gap-2">
                        <input type="text" id="searchUserInput" placeholder="Search users..."
                            class="flex-1 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                        <button onclick="searchUsers()" class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                            <i class="ri-search-line"></i>
                        </button>
                    </div>
                </div>

                <!-- Current Members -->
                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Members</h4>
                    <div id="currentMembersList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Members will be dynamically added here -->
                    </div>
                </div>

                <!-- Add New Members -->
                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Add New Members</h4>
                    <div id="searchResultsList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Search results will be dynamically added here -->
                    </div>
                </div>

                <!-- Save Changes -->
                <div class="mt-4 flex justify-end">
                    <button onclick="saveMemberChanges()" class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Dummy group chat data
    const groupChatData = {
        'Broadcast Channel': {
            name: 'Broadcast Channel',
            type: 'broadcast',
            members: 1500,
            messages: [
                { sender: 'admin', text: 'Welcome to the broadcast channel!', time: '10:00 AM' },
                { sender: 'user1', text: 'Thanks for the welcome!', time: '10:01 AM' },
                { sender: 'admin', text: 'Feel free to ask any questions.', time: '10:02 AM' }
            ]
        },
        'User Support': {
            name: 'User Support',
            type: 'user_chat',
            members: 800,
            messages: [
                { sender: 'admin', text: 'How can we help you today?', time: '9:30 AM' },
                { sender: 'user2', text: 'I have a question about the service.', time: '9:31 AM' }
            ]
        },
        'Community Chat': {
            name: 'Community Chat',
            type: 'customer_service',
            members: 1200,
            messages: [
                { sender: 'admin', text: 'Welcome to the community!', time: '11:00 AM' },
                { sender: 'user3', text: 'Great to be here!', time: '11:01 AM' }
            ]
        }
    };

    let currentGroupChat = null;

    function openGroupChat(groupName) {
        currentGroupChat = groupName;
        const group = groupChatData[groupName];
        
        // Update chat header
        document.getElementById('groupChatName').textContent = group.name;
        document.getElementById('groupChatInfo').textContent = `${group.members} members`;

        // Load messages
        const messagesContainer = document.getElementById('groupChatMessages');
        messagesContainer.innerHTML = '';
        group.messages.forEach(message => {
            const messageElement = createGroupMessageElement(message);
            messagesContainer.appendChild(messageElement);
        });

        // Show modal
        document.getElementById('groupChatModal').classList.remove('hidden');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function closeGroupChat() {
        document.getElementById('groupChatModal').classList.add('hidden');
        currentGroupChat = null;
    }

    function createGroupMessageElement(message) {
        const div = document.createElement('div');
        div.className = `flex ${message.sender === 'admin' ? 'justify-end' : 'justify-start'}`;
        
        const isAdmin = message.sender === 'admin';
        const messageClass = isAdmin ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white';
        const timeClass = isAdmin ? 'text-indigo-200' : 'text-gray-500 dark:text-gray-400';
        
        div.innerHTML = `
            <div class="max-w-[70%] ${messageClass} rounded-lg px-4 py-2 shadow-sm">
                <div class="flex items-center gap-2 mb-1">
                    <p class="text-xs font-medium ${timeClass}">${message.sender}</p>
                    <span class="text-xs ${timeClass}">${message.time}</span>
                </div>
                <p class="text-sm">${message.text}</p>
                <div class="flex items-center justify-end gap-1 mt-1">
                    <span class="text-xs ${timeClass}">${message.time}</span>
                    ${isAdmin ? '<i class="ri-check-double-line text-xs text-indigo-200"></i>' : ''}
                </div>
            </div>
        `;
        
        return div;
    }

    function sendGroupMessage(event) {
        event.preventDefault();
        if (!currentGroupChat) return;

        const input = document.getElementById('groupMessageInput');
        const message = input.value.trim();
        if (!message) return;

        // Add message to chat data
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        groupChatData[currentGroupChat].messages.push({
            sender: 'admin',
            text: message,
            time: time
        });

        // Add message to UI
        const messagesContainer = document.getElementById('groupChatMessages');
        const messageElement = createGroupMessageElement({
            sender: 'admin',
            text: message,
            time: time
        });
        messagesContainer.appendChild(messageElement);

        // Clear input and scroll to bottom
        input.value = '';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Simulate reply after 1 second
        setTimeout(() => {
            const reply = {
                sender: 'user' + Math.floor(Math.random() * 3 + 1),
                text: 'Thanks for the message! This is an automated reply.',
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };
            groupChatData[currentGroupChat].messages.push(reply);
            const replyElement = createGroupMessageElement(reply);
            messagesContainer.appendChild(replyElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 1000);
    }

    // Close group chat when clicking outside
    document.getElementById('groupChatModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeGroupChat();
        }
    });

    // Add Group Modal Functions
    function openAddGroupModal() {
        document.getElementById('addGroupModal').classList.remove('hidden');
    }

    function closeAddGroupModal() {
        document.getElementById('addGroupModal').classList.add('hidden');
    }

    // Edit and Delete Group Functions
    function editGroup(groupId) {
        console.log('Editing group:', groupId);
    }

    function deleteGroup(groupId) {
        console.log('Deleting group:', groupId);
    }

    // Dummy user data for member management
    const dummyUsers = [
        { id: 1, username: 'john_doe', name: 'John Doe', email: 'john@example.com' },
        { id: 2, username: 'jane_smith', name: 'Jane Smith', email: 'jane@example.com' },
        { id: 3, username: 'mike_johnson', name: 'Mike Johnson', email: 'mike@example.com' },
        { id: 4, username: 'sarah_wilson', name: 'Sarah Wilson', email: 'sarah@example.com' },
        { id: 5, username: 'alex_brown', name: 'Alex Brown', email: 'alex@example.com' }
    ];

    // Group member data
    const groupMembers = {
        'Broadcast Channel': [1, 2, 3],
        'User Support': [2, 4, 5],
        'Community Chat': [1, 3, 5]
    };

    let currentManagingGroup = null;

    function openManageMembers(groupName) {
        currentManagingGroup = groupName;
        
        // Update modal title
        document.getElementById('manageMembersTitle').textContent = `Manage Members - ${groupName}`;
        document.getElementById('manageMembersSubtitle').textContent = `${groupChatData[groupName].members} members`;
        
        // Load current members
        loadCurrentMembers(groupName);
        
        // Show modal
        document.getElementById('manageMembersModal').classList.remove('hidden');
    }

    function closeManageMembers() {
        document.getElementById('manageMembersModal').classList.add('hidden');
        currentManagingGroup = null;
        document.getElementById('searchUserInput').value = '';
        document.getElementById('searchResultsList').innerHTML = '';
    }

    function loadCurrentMembers(groupName) {
        const membersList = document.getElementById('currentMembersList');
        membersList.innerHTML = '';
        
        const members = groupMembers[groupName] || [];
        members.forEach(memberId => {
            const user = dummyUsers.find(u => u.id === memberId);
            if (user) {
                const memberElement = createMemberElement(user, true);
                membersList.appendChild(memberElement);
            }
        });
    }

    function createMemberElement(user, isCurrentMember) {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg';
        
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                    <i class="ri-user-line text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-white">${user.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">@${user.username}</p>
                </div>
            </div>
            <button onclick="${isCurrentMember ? 'removeMember' : 'addMember'}(${user.id})" 
                    class="text-sm ${isCurrentMember ? 'text-red-600 hover:text-red-900' : 'text-indigo-600 hover:text-indigo-900'}">
                ${isCurrentMember ? 'Remove' : 'Add'}
            </button>
        `;
        
        return div;
    }

    function searchUsers() {
        const searchTerm = document.getElementById('searchUserInput').value.toLowerCase();
        const resultsList = document.getElementById('searchResultsList');
        resultsList.innerHTML = '';
        
        const currentMembers = groupMembers[currentManagingGroup] || [];
        const filteredUsers = dummyUsers.filter(user => 
            !currentMembers.includes(user.id) &&
            (user.name.toLowerCase().includes(searchTerm) || 
             user.username.toLowerCase().includes(searchTerm) ||
             user.email.toLowerCase().includes(searchTerm))
        );
        
        filteredUsers.forEach(user => {
            const userElement = createMemberElement(user, false);
            resultsList.appendChild(userElement);
        });
    }

    function addMember(userId) {
        if (!groupMembers[currentManagingGroup]) {
            groupMembers[currentManagingGroup] = [];
        }
        groupMembers[currentManagingGroup].push(userId);
        loadCurrentMembers(currentManagingGroup);
        searchUsers(); // Refresh search results
    }

    function removeMember(userId) {
        groupMembers[currentManagingGroup] = groupMembers[currentManagingGroup].filter(id => id !== userId);
        loadCurrentMembers(currentManagingGroup);
        searchUsers(); // Refresh search results
    }

    function saveMemberChanges() {
        // Update member count in group data
        groupChatData[currentManagingGroup].members = groupMembers[currentManagingGroup].length;
        
        // Show success message
        alert('Member changes saved successfully!');
        closeManageMembers();
    }

    // Close manage members modal when clicking outside
    document.getElementById('manageMembersModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeManageMembers();
        }
    });
</script>
{% endblock %} 